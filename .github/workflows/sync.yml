name: Sync luci-app-v2ray-server from kiddin9

on:
  # 手动触发
  workflow_dispatch:
  # 每天 UTC 时间 2:00 自动运行
  schedule:
    - cron: '0 2 * * *'  # UTC 2:00 = 北京时间 10:00

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone and extract luci-app-v2ray-server from kiddin9/kwrt-packages
        run: |
          # 创建临时目录
          mkdir -p tmp-src
          cd tmp-src
          
          # 使用 sparse-checkout 只拉取目标插件（高效！）
          git clone --filter=blob:none --sparse https://github.com/kiddin9/kwrt-packages.git repo
          cd repo
          echo "当前目录和文件1："
          pwd && ls
          git sparse-checkout init --cone
          git sparse-checkout set luci-app-v2ray-server
          echo "当前目录和文件2："
          pwd && ls         
          cd ..
          echo "当前目录和文件3："
          pwd && ls
          # 清理当前目录（保留 .git 和 .github）
          find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          echo "cp 阶段"
          # 复制插件内容到根目录
          cp -r tmp-src/repo/luci-app-v2ray-server/luci-app-v2ray-server/* .
          
          # 获取上游 commit 信息用于提交日志
          UPSTREAM_COMMIT=$(cd tmp-src/repo && git log -1 --format="%H" luci-app-v2ray-server)
          UPSTREAM_DATE=$(cd tmp-src/repo && git log -1 --format="%ad" --date=iso-strict luci-app-v2ray-server)
          
          echo "UPSTREAM_COMMIT=$UPSTREAM_COMMIT" >> $GITHUB_ENV
          echo "UPSTREAM_DATE=$UPSTREAM_DATE" >> $GITHUB_ENV
          
          # 清理临时文件
          rm -rf tmp-src

      - name: Commit and push if changes exist
        run: |
          git add .
          # 检查是否有变更
          if ! git diff --cached --quiet; then
            git commit -m "chore: sync luci-app-v2ray-server from kiddin9/kwrt-packages@$UPSTREAM_COMMIT

            Upstream commit: $UPSTREAM_COMMIT
            Date: $UPSTREAM_DATE
            
            Auto-synced by GitHub Actions."
            git push origin main
            echo "✅ Changes pushed."
          else
            echo "ℹ️ No changes detected. Nothing to push."
          fi
