name: Sync luci-app-v2ray-server to root

on:
  schedule:
    - cron: '30 4 * * *'   # daily ~4:30 UTC / ~12:30 北京时间
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # keep nice linear history

      - name: Checkout upstream shallow
        uses: actions/checkout@v4
        with:
          repository: kiddin9/kwrt-packages
          ref: main
          path: upstream
          fetch-depth: 1

      - name: Replace root with upstream subdirectory contents
        run: |
          # Backup .git (just in case)
          mv .git ../git-backup

          # Nuke everything else in root
          rm -rf ./*

          # Copy only the subdir to root
          cp -r upstream/luci-app-v2ray-server/* .
          cp -r upstream/luci-app-v2ray-server/.[!.]* . 2>/dev/null || true  # hidden files if any

          # Restore .git
          mv ../git-backup .git

          # Clean temp upstream
          rm -rf upstream

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Commit only if anything changed
          git add -A
          git diff --cached --quiet || git commit -m "chore(sync): update luci-app-v2ray-server from upstream $(date '+%Y-%m-%d %H:%M UTC') [skip ci]"

      - name: Force push (safe with lease)
        run: git push origin HEAD:main --force-with-lease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
